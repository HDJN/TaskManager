
@{
    ViewBag.Title = "TaskList";
} 
<html>
<head>
    <script src="~/Scripts/jquery-1.12.3.min.js"></script>
    <script src="~/Scripts/jquery.dataTables.min.js"></script>
    <script src="~/Scripts/dataTables.bootstrap.min.js"></script>
    
    <link href="~/Content/bootstrap.min.css" rel="stylesheet" />
    <link href="~/Content/dataTables.bootstrap.min.css" rel="stylesheet" />
    

    <script src="~/Scripts/common.js"></script>
    <style>
        td.details-control {
            background: url('../../Content/Images/datatable-row-openclose.png')  no-repeat 5px 15px !important 
        }
tr.shown td.details-control {
    background: url('../../Content/Images/datatable-row-openclose.png')  no-repeat 5px -15px !important
}
        .details{
               background-color: #eee;
        }
    </style>
</head>
<body>

    <h2>执行日志</h2>


    <table id="tasklog" class="table table-striped table-bordered" cellspacing="0" width="100%">
        <thead>
            <tr>
                <th></th>
                <th>标识</th>
                <th>执行时间</th>
                <th>结束时间</th>
                <th>耗时</th>
                <th>执行结果</th>
            </tr>
        </thead>
    </table>
    <script>
        
        $(document).ready(function () {
           

            var tasklogTable=$('#tasklog')
                .on('preXhr.dt', function (e, settings, data) {
                    data.PageIndex = data.start / data.length;
                    data.PageSize = data.length;
                    data.SortName = settings.aoColumns[data.order[0].column].data;
                 
                    data.SortOrder = data.order[0].dir;
                })
                .on('xhr.dt', function (e, settings, json, xhr) {
      
                    json.recordsTotal = json.Total;
                    json.recordsFiltered = json.Total;
                    // Note no return - manipulate the data directly in the JSON object.
                }).DataTable({
                "ajax": {
                    "url": '@Url.Action("TaskLogs")',
                    "type": "POST",
                    "data": { "TaskGuid": '@ViewBag.TaskGuid' },
                    "dataSrc": "DataList"
                },
                    "bServerSide": true,
                    "searching":false,
                "iDisplayLength": 10,//每页显示10条数据
                "columns": [
                     {
                         "class": 'details-control',
                         "orderable": false,
                         "data": null,
                         "defaultContent": ''
                     },
                    { "data": "TaskGuid" },
                    {
                        "data": "ExecStatrtTime", render: tableDate
                    },
                    {
                        "data": "ExecEndTime", render: tableDate
                    },
                    {
                        "data": "ExecTime",
                        orderable:false,
                        render: function (data) {

                            var strTime = "";
                            if (data > 1000) {

                                strTime += (data / 1000) + "s";
                            }
                            strTime += data % 1000 + "ms";
                            return strTime;
                        }
                    },
                    {
                        "data": "ExecResultCode",
                        render: function (data) {
                            return data == 0 ? "成功" : data;
                        }
                    },

                ],
                "order": [[2, "desc"]]

            });

            $('#tasklog tbody').on('click', 'td.details-control', function () {
                 
                var tr = $(this).closest('tr');
                
                var row = tasklogTable.row(tr);
                
                if (row.child.isShown()) {
                    // This row is already open - close it
                    row.child.hide();
                    tr.removeClass('shown');
                }
                else {
                    // Open this row
                    row.child(row.data()["ExecResult"], "details").show();
                    tr.addClass('shown');
                }
            });
           
        });
 
    </script>
</body>
</html>